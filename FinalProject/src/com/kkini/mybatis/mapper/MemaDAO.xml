<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org/DTD Mapper 3.0/EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.kkini.mybatis.IMemaDAO">

	<!--  바로그인 유저 메마 리스트 -->
	<select id="memaList" resultType="com.kkini.dto.MemaDTO">
	
	SELECT RESTNAME, REGION, FOODCTG, AGEGROUP, MAINMENU, VISITDATE, DEADLINE, PARTYMEMBERCOUNT, PARTYMASTER, 
    	   ATTENDSCORE, MENUPRICE, ISCLOSED, OPENCODE
	FROM MM_LIST_VIEW
	WHERE ISCLOSED = 'FALSE'
	
	</select>
	
	<!--  로그인 유저 메마 리스트 -->
	<select id="memaListLogin" parameterType="java.lang.String" resultType="com.kkini.dto.MemaDTO">
	
	SELECT RESTNAME, REGION, FOODCTG, AGEGROUP, MAINMENU, VISITDATE, DEADLINE, PARTYMEMBERCOUNT, PARTYMASTER, 
       ATTENDSCORE, MENUPRICE, ISCLOSED, OPENCODE, GENDER
       , (
            SELECT COUNT(*) 
            FROM MM_LIST_VIEW M1, LOGIN_INFO_VIEW L 
            WHERE M1.OPENCODE = M2.OPENCODE
              AND M1.REGION LIKE '%' || #{intregion} ||'%'
         ) AS REGIONMATCH
       , (
            SELECT COUNT(*) 
            FROM MM_LIST_VIEW M1, LOGIN_INFO_VIEW L 
            WHERE M1.OPENCODE = M2.OPENCODE
              AND (M1.GENDER = #{gender} OR M1.GENDER = '무관')
         ) AS GENDERMATCH
	FROM MM_LIST_VIEW M2
	WHERE ISCLOSED = 'FALSE'
	ORDER BY REGIONMATCH + GENDERMATCH DESC, ${genderOrder}, REGIONMATCH DESC
	
	</select>
	
	<!-- 메마 리스트 - 최신순(수정 필요) -->
	<select id="sortMemaListByDate" resultType="com.kkini.dto.MemaDTO">
	
	SELECT RESTNAME, REGION, FOODCTG, AGEGROUP, MAINMENU, VISITDATE, DEADLINE, PARTYMEMBERCOUNT, PARTYMASTER, 
    	   ATTENDSCORE, MENUPRICE, ISCLOSED, OPENCODE
	FROM MM_LIST_VIEW
	WHERE ISCLOSED = 'FALSE'
	ORDER BY OPENCODE DESC
	</select>
	
	
	<!-- 메마 리스트 - 마감임박순 -->
	<select id="sortMemaListByClose" resultType="com.kkini.dto.MemaDTO">
	
	SELECT RESTNAME, REGION, FOODCTG, AGEGROUP, MAINMENU, VISITDATE, DEADLINE, PARTYMEMBERCOUNT, PARTYMASTER, 
    	   ATTENDSCORE, MENUPRICE, ISCLOSED, OPENCODE
	FROM MM_LIST_VIEW
	WHERE ISCLOSED = 'FALSE'
	ORDER BY DEADLINE
	
	</select>
	
	
	<!-- 메마 검색필터 - 연령 -->
	<select id="memaSearchAge" resultType="com.kkini.dto.MemaDTO">
	
	SELECT AGE_GROUP_CASE AS AGEGROUP, AGE_GROUP_CODE AS AGECODE
	FROM AGE_GROUP

	
	</select>
	
	
	<!-- 메마 검색필터 - 성별 -->
	<select id="memaSearchGender" resultType="com.kkini.dto.MemaDTO">
	
	SELECT GENDER_CTG AS GENDER, GENDER_CODE AS GENDERCODE
	FROM GENDER

	
	</select>
	
	
	<!-- 메마 검색필터 - 음식종류-->
	<select id="memaSearchFood" resultType="com.kkini.dto.MemaDTO">
	
	SELECT FOOD_CASE AS FOODCTG, FOOD_CTG_CODE AS FOODCODE
	FROM FOOD_CTG

	</select>
	
	<!-- 메마 검색 리스트 -->
	<select id="searchMema" parameterType="java.lang.String" resultType="com.kkini.dto.MemaDTO">
	
	SELECT A.RESTNAME AS RESTNAME, A.REGION AS REGION, A.FOODCTG AS FOODCTG, A.GENDER AS GENDER, A.AGEGROUP AS AGEGROUP,
       A.MAINMENU AS MAINMENU, A.MENUPRICE AS MENUPRICE, A.VISITDATE AS VISITDATE, A.DEADLINE AS DEADLINE, A.PARTYMEMBERCOUNT AS PARTYMEMBERCOUNT,
       A.ATTENDSCORE AS ATTENDSCORE, A.OPENKEYWORD AS OPENKEYWORD, A.ISCLOSED AS ISCLOSED
	FROM
	(
	SELECT OPENKEYWORD, RESTNAME, REGION, FOODCTG, AGEGROUP, GENDER, MAINMENU, MENUPRICE, VISITDATE, DEADLINE, PARTYMEMBERCOUNT, NOP, PARTYMASTER, ATTENDSCORE, ISCLOSED
	FROM MM_LIST_VIEW
	WHERE AGEGROUP =  (SELECT AGE_GROUP_CASE FROM AGE_GROUP WHERE AGE_GROUP_CODE = #{age}) 
	  AND GENDER = (SELECT GENDER_CTG FROM GENDER WHERE GENDER_CODE = #{gender}) 
	  AND FOODCTG = (SELECT FOOD_CASE FROM FOOD_CTG WHERE FOOD_CTG_CODE = #{food})
	  AND (OPENKEYWORD LIKE '%'|| #{keyword} ||'%' OR RESTNAME LIKE '%'|| #{keyword} ||'%' OR MAINMENU LIKE '%'|| #{keyword} ||'%')
	  AND TO_DATE(VISITDATE, 'YYYY-MM-DD HH24:MI') BETWEEN TO_DATE(#{dateStart},'YYYY-MM-DD HH24:MI') AND TO_DATE(#{dateEnd},'YYYY-MM-DD HH24:MI')
	) A
	WHERE A.ISCLOSED = 'FALSE' OR A.ISCLOSED = 'TRUE'
	
	</select>

</mapper>